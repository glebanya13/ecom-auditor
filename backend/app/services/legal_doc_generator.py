"""
Legal Document Generator
Генератор юридических документов для продавцов на маркетплейсах.

Правовая база:
- ФЗ № 289-ФЗ «О деятельности операторов агрегаторов информации о товарах»
- ФЗ № 135-ФЗ «О защите конкуренции»
- ГК РФ (ст. 469, 475, 506-524 — качество и возврат товара)
- НК РФ (ст. 164, 168, 173 — НДС)

Все документы являются шаблонами и не заменяют юридическую консультацию.
"""
import re
from datetime import datetime
from typing import Dict, Any, Optional


# ---------------------------------------------------------------------------
# Внутренние утилиты
# ---------------------------------------------------------------------------

def _fmt_date(iso_date: Optional[str] = None) -> str:
    """Форматирует дату ISO → DD.MM.YYYY. Если None — сегодняшняя дата."""
    if iso_date:
        try:
            return datetime.fromisoformat(iso_date).strftime("%d.%m.%Y")
        except ValueError:
            pass
    return datetime.now().strftime("%d.%m.%Y")


def _validate_non_empty(value: str, field_name: str) -> str:
    if not value or not value.strip():
        raise ValueError(f"Поле '{field_name}' не может быть пустым")
    return value.strip()


# ---------------------------------------------------------------------------
# Маппинги нарушений → правовая база
# ---------------------------------------------------------------------------

VIOLATION_ARTICLES: Dict[str, Dict[str, str]] = {
    "unauthorized_penalty": {
        "article": "ст. 5 ФЗ № 289-ФЗ",
        "short": "нарушение прозрачности алгоритмов применения штрафов",
        "obligation": "предоставлять детальное обоснование штрафных санкций с доказательствами нарушения",
    },
    "ranking_manipulation": {
        "article": "ст. 5 ФЗ № 289-ФЗ",
        "short": "необоснованная пессимизация позиций в поисковой выдаче",
        "obligation": "обеспечивать прозрачность алгоритмов ранжирования и не применять скрытые санкции",
    },
    "unfair_blocking": {
        "article": "ст. 6 ФЗ № 289-ФЗ",
        "short": "блокировка карточки товара без законного основания",
        "obligation": "не блокировать товары без обоснованного нарушения правил платформы",
    },
    "forced_promotion": {
        "article": "ст. 4 ФЗ № 289-ФЗ",
        "short": "принуждение к участию в акции / промо-программе",
        "obligation": "не принуждать продавцов к обязательному участию в промоакциях",
    },
    "offer_change_no_notice": {
        "article": "ст. 4 ФЗ № 289-ФЗ",
        "short": "изменение условий оферты без 45-дневного уведомления",
        "obligation": "уведомлять продавцов об изменении существенных условий не менее чем за 45 календарных дней",
    },
    "unlawful_return": {
        "article": "ст. 469, 475 ГК РФ",
        "short": "необоснованный возврат товара",
        "obligation": "принимать возвраты только при наличии законного основания (ненадлежащее качество, неверная комплектация)",
    },
    "price_dumping_demand": {
        "article": "ст. 10 ФЗ № 135-ФЗ",
        "short": "требование снижения цены ниже себестоимости",
        "obligation": "не злоупотреблять доминирующим положением путём диктата ценовых условий",
    },
}


# ---------------------------------------------------------------------------
# Основной класс
# ---------------------------------------------------------------------------

class LegalDocGenerator:
    """
    Генератор юридических документов.

    Все методы возвращают строку — готовый текст документа.
    Перед отправкой рекомендуется проверить документ с юристом.
    """

    # ------------------------------------------------------------------
    # 1. Досудебная претензия по ФЗ-289
    # ------------------------------------------------------------------

    def generate_complaint_289fz(
        self,
        seller_name: str,
        seller_inn: str,
        marketplace_name: str,
        marketplace_legal_name: str,
        article_number: str,
        violation_type: str,
        violation_date: str,
        violation_description: str,
        penalty_amount: float = 0.0,
        seller_ogrn: str = "",
        seller_contact: str = "",
    ) -> str:
        """
        Генерирует досудебную претензию по ФЗ № 289-ФЗ.

        Args:
            seller_name: ФИО или наименование продавца.
            seller_inn: ИНН продавца.
            marketplace_name: Отображаемое имя маркетплейса.
            marketplace_legal_name: Юридическое название компании маркетплейса.
            article_number: Артикул товара на маркетплейсе.
            violation_type: Тип нарушения (из VIOLATION_ARTICLES).
            violation_date: Дата нарушения ISO (YYYY-MM-DD).
            violation_description: Подробное описание нарушения.
            penalty_amount: Сумма незаконного штрафа (0 если нет).
            seller_ogrn: ОГРН/ОГРНИП продавца (опционально).
            seller_contact: Email или телефон для ответа (опционально).
        """
        _validate_non_empty(seller_name, "seller_name")
        _validate_non_empty(marketplace_name, "marketplace_name")
        _validate_non_empty(article_number, "article_number")
        _validate_non_empty(violation_description, "violation_description")

        info = VIOLATION_ARTICLES.get(
            violation_type,
            {
                "article": "ФЗ № 289-ФЗ",
                "short": "нарушение требований законодательства",
                "obligation": "соблюдать нормы ФЗ № 289-ФЗ",
            },
        )

        today = _fmt_date()
        viol_date_fmt = _fmt_date(violation_date)
        penalty_str = (
            f" с удержанием суммы {penalty_amount:,.2f} руб."
            if penalty_amount > 0 else ""
        )
        penalty_demand = (
            f"   — Возвратить необоснованно удержанную сумму {penalty_amount:,.2f} руб. "
            f"в течение 5 (пяти) рабочих дней\n"
            if penalty_amount > 0 else ""
        )
        inn_line = f"ИНН: {seller_inn}\n" if seller_inn else ""
        ogrn_line = f"ОГРН/ОГРНИП: {seller_ogrn}\n" if seller_ogrn else ""
        contact_line = f"Контакт для ответа: {seller_contact}\n" if seller_contact else "(указывается при отправке)\n"

        return f"""ДОСУДЕБНАЯ ПРЕТЕНЗИЯ
по факту нарушения требований ФЗ № 289-ФЗ «О деятельности операторов агрегаторов информации о товарах»

От: {seller_name}
{inn_line}{ogrn_line}Дата составления: {today}

Кому: {marketplace_legal_name} ({marketplace_name})

════════════════════════════════════════════════════════
ПРАВОВОЕ ОСНОВАНИЕ
════════════════════════════════════════════════════════

Федеральный закон от 08.08.2024 № 289-ФЗ «О деятельности операторов агрегаторов информации о товарах (услугах) и о внесении изменений в отдельные законодательные акты Российской Федерации» (далее — ФЗ-289).

════════════════════════════════════════════════════════
СУТЬ ПРЕТЕНЗИИ
════════════════════════════════════════════════════════

В отношении товара с артикулом **{article_number}** {marketplace_legal_name} совершило действие, квалифицируемое как «{info['short']}»{penalty_str}.

• Дата нарушения: {viol_date_fmt}
• Артикул/SKU: {article_number}
• Маркетплейс: {marketplace_name}
• Описание: {violation_description}

════════════════════════════════════════════════════════
НАРУШЕННЫЕ НОРМЫ ПРАВА
════════════════════════════════════════════════════════

Согласно {info['article']}, оператор агрегатора обязан {info['obligation']}.

Кроме того, на основании общих принципов ФЗ-289 оператор обязан:
1. Обеспечивать прозрачность алгоритмов ранжирования и применения мер воздействия.
2. Уведомлять продавцов о существенных изменениях условий не менее чем за 45 дней.
3. Предоставлять мотивированное обоснование каждой применяемой санкции.
4. Не создавать дискриминационных условий для отдельных продавцов.

════════════════════════════════════════════════════════
ТРЕБОВАНИЯ
════════════════════════════════════════════════════════

В течение 3 (трёх) рабочих дней с момента получения настоящей претензии прошу:

1. ПРЕДОСТАВИТЬ в письменной форме:
   — Детальное правовое обоснование совершённых действий
   — Ссылки на конкретные пункты Правил платформы, нарушенных продавцом
   — Доказательства совершения нарушения

2. УСТРАНИТЬ нарушение:
   — Отменить применённую меру воздействия
{penalty_demand}   — Восстановить позиции товара в поисковой выдаче (при наличии пессимизации)

3. НАПРАВИТЬ письменное подтверждение исполнения требований.

════════════════════════════════════════════════════════
ПОСЛЕДСТВИЯ НЕИСПОЛНЕНИЯ
════════════════════════════════════════════════════════

В случае отсутствия мотивированного ответа в установленный срок или неисполнения законных требований настоящая претензия, вместе с собранными доказательствами, будет направлена:

1. В Федеральную антимонопольную службу (ФАС России) — для проверки соответствия действий {marketplace_name} требованиям ФЗ-289 и ФЗ-135 «О защите конкуренции»
2. В Федеральную налоговую службу — для проверки правомерности финансовых удержаний и их налогового учёта
3. В Арбитражный суд — с исковым заявлением о взыскании убытков, упущенной выгоды и штрафа за несоблюдение досудебного порядка

────────────────────────────────────────────────────────
С уважением,

{seller_name}
Дата: {today}
{contact_line}
────────────────────────────────────────────────────────
⚠️  Документ сгенерирован системой E-Com Auditor 2026.
    Не является юридической консультацией.
    Перед отправкой рекомендуется консультация с юристом.
────────────────────────────────────────────────────────""".strip()

    # ------------------------------------------------------------------
    # 2. Жалоба в ФАС
    # ------------------------------------------------------------------

    def generate_fas_complaint(
        self,
        seller_name: str,
        marketplace_name: str,
        violation_description: str,
        evidence_description: str,
        seller_inn: str = "",
    ) -> str:
        """
        Генерирует жалобу в Федеральную антимонопольную службу.

        Применяется при:
        - Злоупотреблении доминирующим положением (ст. 10 ФЗ-135)
        - Недобросовестной конкуренции (ст. 14 ФЗ-135)
        - Нарушении прозрачности алгоритмов (ст. 5 ФЗ-289)
        """
        _validate_non_empty(seller_name, "seller_name")
        _validate_non_empty(marketplace_name, "marketplace_name")
        _validate_non_empty(violation_description, "violation_description")
        _validate_non_empty(evidence_description, "evidence_description")

        today = _fmt_date()
        inn_line = f"ИНН: {seller_inn}\n" if seller_inn else ""

        return f"""ЖАЛОБА
в Федеральную антимонопольную службу России

От: {seller_name}
{inn_line}Дата: {today}

Адресат: ФАС России / территориальное управление ФАС
         по месту нахождения оператора агрегатора

════════════════════════════════════════════════════════
ПРАВОВОЕ ОСНОВАНИЕ
════════════════════════════════════════════════════════

• ФЗ № 135-ФЗ от 26.07.2006 «О защите конкуренции»
• ФЗ № 289-ФЗ от 08.08.2024 «О деятельности операторов агрегаторов информации о товарах»

════════════════════════════════════════════════════════
ПРЕДМЕТ ЖАЛОБЫ
════════════════════════════════════════════════════════

Прошу провести проверку деятельности оператора агрегатора **{marketplace_name}** на предмет соблюдения антимонопольного законодательства и требований ФЗ-289.

════════════════════════════════════════════════════════
ОБСТОЯТЕЛЬСТВА ДЕЛА
════════════════════════════════════════════════════════

{violation_description}

════════════════════════════════════════════════════════
ДОКАЗАТЕЛЬСТВА
════════════════════════════════════════════════════════

{evidence_description}

════════════════════════════════════════════════════════
НАРУШЕННЫЕ НОРМЫ
════════════════════════════════════════════════════════

Указанные действия {marketplace_name} могут нарушать:
• Запрет на злоупотребление доминирующим положением (ст. 10 ФЗ-135)
• Запрет на недобросовестную конкуренцию (ст. 14 ФЗ-135)
• Принципы прозрачности и недискриминации (ст. 5 ФЗ-289)
• Требование о 45-дневном уведомлении об изменениях (ст. 4 ФЗ-289)

════════════════════════════════════════════════════════
ПРОСЬБА
════════════════════════════════════════════════════════

1. Провести проверку деятельности {marketplace_name} по изложенным фактам.
2. Принять меры антимонопольного реагирования.
3. Уведомить заявителя о результатах проверки.

Приложения:
□ 1. Скриншоты переписки с маркетплейсом
□ 2. Данные аналитики (статистика продаж, позиций)
□ 3. Копия досудебной претензии с отметкой о вручении
□ 4. Иные доказательства (указать при наличии)

────────────────────────────────────────────────────────
{seller_name}
{today}
────────────────────────────────────────────────────────
⚠️  Документ сгенерирован системой E-Com Auditor 2026.
    Не является юридической консультацией.
────────────────────────────────────────────────────────""".strip()

    # ------------------------------------------------------------------
    # 3. Уведомление об изменении оферты
    # ------------------------------------------------------------------

    def generate_offer_change_notification(
        self,
        change_description: str,
        change_date: str,
        notification_requirement_days: int = 45,
    ) -> str:
        """
        Генерирует документ-фиксацию нарушения срока уведомления об изменении оферты.
        Согласно ст. 4 ФЗ-289, маркетплейс обязан уведомить за 45 дней.
        """
        _validate_non_empty(change_description, "change_description")

        today = _fmt_date()
        change_date_fmt = _fmt_date(change_date)

        return f"""УВЕДОМЛЕНИЕ-ФИКСАЦИЯ
нарушения порядка уведомления об изменении условий оферты

Дата фиксации: {today}

════════════════════════════════════════════════════════
ПРАВОВОЕ ОСНОВАНИЕ
════════════════════════════════════════════════════════

Статья 4 ФЗ № 289-ФЗ: оператор агрегатора обязан уведомлять продавцов
об изменении существенных условий договора не менее чем
за {notification_requirement_days} (сорок пять) календарных дней до их вступления в силу.

════════════════════════════════════════════════════════
СВЕДЕНИЯ ОБ ИЗМЕНЕНИИ
════════════════════════════════════════════════════════

Дата вступления изменений в силу: {change_date_fmt}
Характер изменений: {change_description}

════════════════════════════════════════════════════════
ВАЖНО ДЛЯ ПРОДАВЦА
════════════════════════════════════════════════════════

1. Сохраните настоящий документ как доказательство даты получения уведомления об изменениях.
2. Если уведомление получено менее чем за {notification_requirement_days} дней до вступления изменений в силу — это нарушение ФЗ-289.
3. В этом случае вы вправе отказаться от договора без штрафных санкций (ст. 4 ч. 6 ФЗ-289).
4. Требуйте письменного подтверждения даты уведомления от маркетплейса.

Рекомендуемые действия при нарушении срока:
• Направить досудебную претензию с требованием соблюдения ФЗ-289
• Зафиксировать факт нарушения скриншотами (дата уведомления в ЛК)
• При отказе — направить жалобу в ФАС России

────────────────────────────────────────────────────────
⚠️  Документ сгенерирован системой E-Com Auditor 2026.
    Не является юридической консультацией.
────────────────────────────────────────────────────────""".strip()

    # ------------------------------------------------------------------
    # 4. Пояснение по НДС для ФНС
    # ------------------------------------------------------------------

    def generate_fns_vat_explanation(
        self,
        seller_name: str,
        seller_inn: str,
        tax_period: str,
        marketplace_name: str,
        gross_revenue: float,
        marketplace_fee: float,
        vat_rate: float = 0.22,
        vat_amount: Optional[float] = None,
    ) -> str:
        """
        Генерирует пояснение для ФНС по НДС при работе через маркетплейс.

        Актуально для плательщиков НДС (ОСНО), работающих через агентскую схему.
        Налоговая база = выручка от продаж, НДС исчисляется по ставке 22% (2026 г.).

        Args:
            seller_name: Наименование продавца (юрлицо/ИП).
            seller_inn: ИНН продавца.
            tax_period: Налоговый период, напр. «1 квартал 2026 г.».
            marketplace_name: Название маркетплейса.
            gross_revenue: Валовая выручка от продаж за период (руб.).
            marketplace_fee: Комиссия маркетплейса (руб.).
            vat_rate: Ставка НДС (0.22 для 2026 г.).
            vat_amount: Сумма НДС (вычисляется автоматически если None).
        """
        _validate_non_empty(seller_name, "seller_name")
        _validate_non_empty(seller_inn, "seller_inn")
        if not re.match(r"^\d{10}$|^\d{12}$", seller_inn):
            raise ValueError("ИНН должен содержать 10 или 12 цифр")

        today = _fmt_date()
        if vat_amount is None:
            vat_amount = gross_revenue * vat_rate / (1 + vat_rate)  # НДС «внутри»
        net_revenue = gross_revenue - vat_amount
        net_profit = net_revenue - marketplace_fee
        vat_pct = int(vat_rate * 100)

        return f"""ПОЯСНЕНИЕ
по вопросу исчисления и уплаты НДС
при реализации товаров через маркетплейс

Дата: {today}

В ИФНС по месту постановки на учёт

От: {seller_name}
ИНН: {seller_inn}
Налоговый период: {tax_period}

════════════════════════════════════════════════════════
СУЩЕСТВО ПОЯСНЕНИЯ
════════════════════════════════════════════════════════

Настоящее пояснение представляется в связи с вопросами, касающимися
порядка исчисления НДС при продаже товаров через агрегатор {marketplace_name}.

════════════════════════════════════════════════════════
СХЕМА РАБОТЫ
════════════════════════════════════════════════════════

Деятельность осуществляется по агентской схеме:
• {marketplace_name} является агентом (комиссионером)
• Продавец является принципалом (комитентом)
• {marketplace_name} реализует товары от своего имени, но за счёт продавца
• Комиссия маркетплейса облагается НДС на стороне агента

════════════════════════════════════════════════════════
РАСЧЁТ НДС ЗА {tax_period.upper()}
════════════════════════════════════════════════════════

Показатель                               Сумма (руб.)
────────────────────────────────────────────────────────
Валовая выручка от реализации:      {gross_revenue:>15,.2f}
Комиссия {marketplace_name[:15]:<15}:      {marketplace_fee:>15,.2f}
НДС {vat_pct}% (расчётная ставка):       {vat_amount:>15,.2f}
Выручка без НДС:                    {net_revenue:>15,.2f}
Прибыль после комиссии и НДС:       {net_profit:>15,.2f}
────────────────────────────────────────────────────────

Ставка НДС применяется в соответствии с п. 3 ст. 164 НК РФ — {vat_pct}%.
Налоговая база определена согласно ст. 153 НК РФ.

════════════════════════════════════════════════════════
ПОДТВЕРЖДАЮЩИЕ ДОКУМЕНТЫ
════════════════════════════════════════════════════════

□ 1. Отчёты агента ({marketplace_name}) за {tax_period}
□ 2. Счета-фактуры, выставленные агентом
□ 3. Акты приёмки-передачи / отчёты о реализации
□ 4. Выписка о движении денежных средств

────────────────────────────────────────────────────────
{seller_name}
{today}
────────────────────────────────────────────────────────
⚠️  Документ сгенерирован системой E-Com Auditor 2026.
    Не является налоговой консультацией.
────────────────────────────────────────────────────────""".strip()

    # ------------------------------------------------------------------
    # 5. Оспаривание необоснованного возврата
    # ------------------------------------------------------------------

    def generate_return_dispute(
        self,
        seller_name: str,
        marketplace_name: str,
        order_number: str,
        return_date: str,
        product_name: str,
        return_reason_stated: str,
        dispute_grounds: str,
        product_cost: float = 0.0,
    ) -> str:
        """
        Генерирует претензию-оспаривание необоснованного возврата товара.

        Применяется когда маркетплейс принял возврат от покупателя
        без законных оснований (товар надлежащего качества, нет брака).

        Args:
            seller_name: Наименование продавца.
            marketplace_name: Название маркетплейса.
            order_number: Номер заказа/возврата.
            return_date: Дата возврата (ISO).
            product_name: Наименование товара.
            return_reason_stated: Причина возврата, указанная маркетплейсом.
            dispute_grounds: Основания оспаривания (почему возврат необоснован).
            product_cost: Стоимость товара (руб.).
        """
        _validate_non_empty(seller_name, "seller_name")
        _validate_non_empty(marketplace_name, "marketplace_name")
        _validate_non_empty(order_number, "order_number")
        _validate_non_empty(dispute_grounds, "dispute_grounds")

        today = _fmt_date()
        return_date_fmt = _fmt_date(return_date)
        cost_line = (
            f"Стоимость товара: {product_cost:,.2f} руб.\n"
            if product_cost > 0 else ""
        )
        cost_demand = (
            f"   — Возместить стоимость товара в размере {product_cost:,.2f} руб.\n"
            if product_cost > 0 else ""
        )

        return f"""ПРЕТЕНЗИЯ
об оспаривании необоснованного возврата товара

Дата: {today}

От: {seller_name}
Кому: {marketplace_name}

════════════════════════════════════════════════════════
ПРАВОВОЕ ОСНОВАНИЕ
════════════════════════════════════════════════════════

• Статья 469 ГК РФ — качество товара
• Статья 475 ГК РФ — последствия передачи товара ненадлежащего качества
• Статья 18 Закона РФ № 2300-1 «О защите прав потребителей»
• Правила возврата товаров на {marketplace_name}

════════════════════════════════════════════════════════
СВЕДЕНИЯ О ВОЗВРАТЕ
════════════════════════════════════════════════════════

Номер заказа/возврата: {order_number}
Дата возврата: {return_date_fmt}
Наименование товара: {product_name}
{cost_line}Причина возврата, указанная маркетплейсом: {return_reason_stated}

════════════════════════════════════════════════════════
ОСНОВАНИЯ ДЛЯ ОСПАРИВАНИЯ
════════════════════════════════════════════════════════

{dispute_grounds}

════════════════════════════════════════════════════════
ТРЕБОВАНИЯ
════════════════════════════════════════════════════════

1. Провести независимую экспертизу возвращённого товара.
2. Предоставить документальное подтверждение наличия брака (фото, акт экспертизы).
{cost_demand}3. При отсутствии законных оснований для возврата — признать возврат необоснованным.

════════════════════════════════════════════════════════
ПОСЛЕДСТВИЯ НЕИСПОЛНЕНИЯ
════════════════════════════════════════════════════════

При неудовлетворении претензии в течение 10 (десяти) рабочих дней
будут приняты следующие меры:
• Направление жалобы в Роспотребнадзор
• Обращение в арбитражный суд с иском о взыскании убытков
• Направление жалобы в ФАС (при системных нарушениях)

────────────────────────────────────────────────────────
{seller_name}
{today}
────────────────────────────────────────────────────────
⚠️  Документ сгенерирован системой E-Com Auditor 2026.
    Не является юридической консультацией.
────────────────────────────────────────────────────────""".strip()

    # ------------------------------------------------------------------
    # Служебные методы
    # ------------------------------------------------------------------

    def get_template_list(self) -> Dict[str, Any]:
        """Возвращает список доступных шаблонов с описаниями."""
        return {
            "complaint_289fz": {
                "name": "Досудебная претензия по ФЗ-289",
                "description": "Претензия маркетплейсу за нарушения алгоритмов, штрафов или блокировок",
                "legal_basis": "ФЗ № 289-ФЗ",
                "supported_violations": list(VIOLATION_ARTICLES.keys()),
            },
            "fas_complaint": {
                "name": "Жалоба в ФАС",
                "description": "Жалоба на антиконкурентные действия маркетплейса",
                "legal_basis": "ФЗ № 135-ФЗ, ФЗ № 289-ФЗ",
                "supported_violations": ["ranking_manipulation", "price_dumping_demand"],
            },
            "offer_change_notification": {
                "name": "Фиксация нарушения срока уведомления об оферте",
                "description": "Документ-фиксация нарушения 45-дневного срока по ст. 4 ФЗ-289",
                "legal_basis": "ст. 4 ФЗ № 289-ФЗ",
                "supported_violations": ["offer_change_no_notice"],
            },
            "fns_vat_explanation": {
                "name": "Пояснение по НДС для ФНС",
                "description": "Пояснение порядка исчисления НДС при работе через агрегатор",
                "legal_basis": "НК РФ ст. 153, 164, 168",
                "supported_violations": [],
            },
            "return_dispute": {
                "name": "Оспаривание необоснованного возврата",
                "description": "Претензия маркетплейсу за принятие необоснованного возврата",
                "legal_basis": "ГК РФ ст. 469, 475; ЗоЗПП ст. 18",
                "supported_violations": ["unlawful_return"],
            },
        }
